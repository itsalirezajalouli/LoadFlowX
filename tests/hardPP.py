import pandapower as pp
import numpy as np

# Create an empty network
net = pp.create_empty_network()

# Define base values
base_mva = 100  # System base MVA
base_kv = 345   # Base voltage for the majority of buses

# Bus data
Bus = np.array([
    [1, 345], [2, 345], [3, 345], [4, 345], [5, 345], [6, 345], [7, 345], [8, 345], [9, 345], [10, 345],
    [11, 345], [12, 230], [13, 345], [14, 345], [15, 345], [16, 345], [17, 345], [18, 345], [19, 345], [20, 345],
    [21, 345], [22, 345], [23, 345], [24, 345], [25, 345], [26, 345], [27, 345], [28, 345], [29, 345], [30, 22],
    [31, 22], [32, 22], [33, 22], [34, 22], [35, 22], [36, 22], [37, 22], [38, 22], [39, 345]
])

# Line data
line = np.array([
    [1, 2, 0.0035, 0.0411, 0.6987, 0, 100, 345],
    [1, 39, 0.001, 0.025, 0.75, 0, 100, 345],
    [2, 3, 0.0013, 0.0151, 0.2572, 0, 100, 345],
    [2, 25, 0.007, 0.0086, 0.146, 0, 100, 345],
    [2, 30, 0, 0.0181, 0, 1.025, 100, 22],
    [3, 4, 0.0013, 0.0213, 0.2214, 0, 100, 345],
    [3, 18, 0.0011, 0.0133, 0.2138, 0, 100, 345],
    [4, 5, 0.0008, 0.0128, 0.1342, 0, 100, 345],
    [4, 14, 0.0008, 0.0129, 0.1382, 0, 100, 345],
    [5, 8, 0.0008, 0.0112, 0.1476, 0, 100, 345],
    [6, 5, 0.0002, 0.0026, 0.0434, 0, 100, 345],
    [6, 7, 0.0006, 0.0092, 0.113, 0, 100, 345],
    [6, 11, 0.0007, 0.0082, 0.1389, 0, 100, 345],
    [7, 8, 0.0004, 0.0046, 0.078, 0, 100, 345],
    [8, 9, 0.0023, 0.0363, 0.3804, 0, 100, 345],
    [9, 39, 0.001, 0.025, 1.2, 0, 100, 345],
    [10, 11, 0.0004, 0.0043, 0.0729, 0, 100, 345],
    [10, 13, 0.0004, 0.0043, 0.0729, 0, 100, 345],
    [10, 32, 0, 0.02, 0, 1.07, 100, 22],
    [12, 11, 0.0016, 0.0435, 0, 1.006, 100, 345],
    [12, 13, 0.0016, 0.0435, 0, 1.006, 100, 345],
    [13, 14, 0.0009, 0.0101, 0.1723, 0, 100, 345],
    [14, 15, 0.0018, 0.0217, 0.366, 0, 100, 345],
    [15, 16, 0.0009, 0.0094, 0.171, 0, 100, 345],
    [16, 17, 0.0007, 0.0089, 0.1342, 0, 100, 345],
    [16, 19, 0.0016, 0.0195, 0.304, 0, 100, 345],
    [16, 21, 0.0008, 0.0135, 0.2548, 0, 100, 345],
    [16, 24, 0.0003, 0.0059, 0.068, 0, 100, 345],
    [17, 18, 0.0007, 0.0082, 0.1319, 0, 100, 345],
    [17, 27, 0.0013, 0.0173, 0.3216, 0, 100, 345],
    [19, 33, 0.0007, 0.0142, 0, 1.07, 100, 22],
    [19, 20, 0.0007, 0.0138, 0, 1.06, 100, 345],
    [20, 34, 0.0009, 0.018, 0, 1.009, 100, 22],
    [21, 22, 0.0008, 0.014, 0.2565, 0, 100, 345],
    [22, 23, 0.0006, 0.0096, 0.1846, 0, 100, 345],
    [22, 35, 0, 0.0143, 0, 1.025, 100, 22],
    [23, 24, 0.0022, 0.035, 0.361, 0, 100, 345],
    [23, 36, 0.0005, 0.0272, 0, 1, 100, 22],
    [25, 26, 0.0032, 0.0323, 0.513, 0, 100, 345],
    [25, 37, 0.0006, 0.0232, 0, 1.025, 100, 22],
    [26, 27, 0.0014, 0.0147, 0.2396, 0, 100, 345],
    [26, 28, 0.0043, 0.0474, 0.7802, 0, 100, 345],
    [26, 29, 0.0057, 0.0625, 1.029, 0, 100, 345],
    [28, 29, 0.0014, 0.0151, 0.249, 0, 100, 345],
    [29, 38, 0.0008, 0.0156, 0, 1.025, 100, 22],
    [31, 6, 0, 0.025, 0, 1, 100, 22]
])

# Add buses
for bus in Bus:
    bus_number = int(bus[0])
    nominal_voltage = bus[1]
    pp.create_bus(net, vn_kv=nominal_voltage, name=f"Bus {bus_number}", index=bus_number)

# Add lines
for line_data in line:
    from_bus = int(line_data[0])
    to_bus = int(line_data[1])
    r_ohm = line_data[2]  # Resistance (pu)
    x_ohm = line_data[3]  # Reactance (pu)
    c_nf = line_data[4]   # Capacitance (pu)
    tap = line_data[5]    # Transformer tap (0 for lines, non-zero for transformers)
    base_mva_line = line_data[6]
    base_kv_line = line_data[7]

    # Convert pu values to physical values
    z_base = (base_kv_line**2) / base_mva_line
    r_ohm_physical = r_ohm * z_base
    x_ohm_physical = x_ohm * z_base
    c_nf_physical = c_nf / z_base

    if tap == 0:  # It's a line
        pp.create_line_from_parameters(
            net, from_bus=from_bus, to_bus=to_bus, length_km=1, r_ohm_per_km=r_ohm_physical,
            x_ohm_per_km=x_ohm_physical, c_nf_per_km=c_nf_physical, max_i_ka=1, name=f"Line {from_bus}-{to_bus}"
        )
    else:  # It's a transformer
        pp.create_transformer(
            net, hv_bus=from_bus, lv_bus=to_bus, std_type="0.4 MVA 20/0.4 kV", tap_pos=0,
            name=f"Transformer {from_bus}-{to_bus}"
        )

# Generator data
mac_con = np.array([
    [1, 39, 1000.0, 0.030, 0.0010, 0.200, 0.060, 0.01, 7.000, 0.003, 0.190, 0.080, 0.03, 0.700, 0.005, 50.00, 0.000, 0.00, 39],
    [2, 31, 1000.0, 0.350, 0.0270, 2.950, 0.697, 0.01, 6.560, 0.003, 2.820, 1.7, 0.03, 1.500, 0.005, 3.030, 0.000, 0.00, 31],
    [3, 32, 1000.0, 0.304, 0.00386, 2.495, 0.531, 0.01, 5.700, 0.003, 2.370, 0.876, 0.03, 1.500, 0.005, 3.580, 0.000, 0.00, 32],
    [4, 33, 1000.0, 0.295, 0.00222, 2.620, 0.436, 0.01, 5.690, 0.003, 2.580, 1.66, 0.03, 1.500, 0.005, 2.860, 0.000, 0.00, 33],
    [5, 34, 1000.0, 0.540, 0.0014, 6.700, 1.320, 0.01, 5.400, 0.003, 6.200, 1.66, 0.03, 0.440, 0.005, 2.600, 0.000, 0.00, 34],
    [6, 35, 1000.0, 0.224, 0.0615, 2.540, 0.500, 0.01, 7.300, 0.003, 2.410, 0.814, 0.03, 0.400, 0.005, 3.480, 0.000, 0.00, 35],
    [7, 36, 1000.0, 0.322, 0.00268, 2.950, 0.490, 0.01, 5.660, 0.003, 2.920, 1.86, 0.03, 1.500, 0.005, 2.640, 0.000, 0.00, 36],
    [8, 37, 1000.0, 0.280, 0.00686, 2.900, 0.570, 0.01, 6.700, 0.003, 2.800, 0.911, 0.03, 0.410, 0.005, 2.430, 0.000, 0.00, 37],
    [9, 38, 1000.0, 0.298, 0.0030, 2.106, 0.570, 0.01, 4.790, 0.003, 2.050, 0.587, 0.03, 1.960, 0.005, 3.450, 0.000, 0.00, 38],
    [10, 30, 1000.0, 0.125, 0.0014, 1.000, 0.310, 0.01, 10.20, 0.003, 0.690, 0.08, 0.03, 1.500, 0.005, 4.200, 0.000, 0.00, 30]
])

# Active power generation (scaled to MW)
p0 = np.array([1000, 520.81, 650, 632, 508, 650, 560, 540, 830, 250]) / 1000 * base_mva

# Add generators
for i, gen in enumerate(mac_con):
    bus_number = int(gen[1])
    pp.create_gen(
        net, bus=bus_number, p_mw=p0[i], vm_pu=1.0, name=f"Generator {bus_number}"
    )

# Add loads (placeholder loads)
for bus in Bus:
    bus_number = int(bus[0])
    pp.create_load(
        net, bus=bus_number, p_mw=0, q_mvar=0, name=f"Load {bus_number}"
    )

pp.create_ext_grid(net, bus = 31, vm_pu = 0.982, max_p_mw = 646.0)

# Run power flow
pp.runpp(net)

# Print results
print('Bus Results: ')
print(net.res_bus)
print('\nLine Results: ')
print(net.res_line)
